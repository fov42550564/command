'use strict';
var page = require('webpage').create(),
server = require('webserver').create();

var createChart = function(inputOption, width, height) {
    var script= document.createElement('script');
    script.setAttribute('type', 'text/javascript');
    script.innerHTML = 'var options = ' + JSON.stringify(inputOption);
    document.getElementsByTagName('head')[0].appendChild(script);

    document.body.style.backgroundColor = 'white';
    var container = document.getElementById('container');
    container.style.width = width+'px';
    container.style.height = height+'px';
    var chart = echarts.init(container);
    chart.setOption(options);
};


page.open('tpl.html', function(status) {
    server.listen(3003, function (request, response) {
        try {
            var data = JSON.parse(request.post);
            var width = data.width;
            var height = data.height;
            var options = data.options;
            console.log(options, width, height);
            page.evaluate(createChart, options, width, height);
            page.clipRect = {top: 0, left: 0, width: width, height: height };
            response.write(page.renderBase64());
            response.close();
        } catch(e) {}
    });
});
